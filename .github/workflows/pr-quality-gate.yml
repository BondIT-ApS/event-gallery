name: ğŸ§± LEGO Quality Gate - PR Validation

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  checks: write
  security-events: write
  packages: read
  actions: read

jobs:
  # ğŸ” Discover changes and post LEGO-themed comment
  discover-changes:
    name: ğŸ” Discover LEGO Building Plan
    runs-on: ubuntu-latest
    outputs:
      frontend-changed: ${{ steps.changes.outputs.frontend }}
      backend-changed: ${{ steps.changes.outputs.backend }}
      workflows-changed: ${{ steps.changes.outputs.workflows }}
      lines-changed: ${{ steps.stats.outputs.lines-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        run: |
          # Get changed files
          CHANGED_FILES=$(git diff --name-only "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}")
          echo "Changed files: $CHANGED_FILES"
          
          # Check if frontend changed
          if echo "$CHANGED_FILES" | grep -E '^frontend/' > /dev/null; then
            echo "frontend=true" >> "$GITHUB_OUTPUT"
          else
            echo "frontend=false" >> "$GITHUB_OUTPUT"
          fi
          
          # Check if backend changed
          if echo "$CHANGED_FILES" | grep -E '^backend/' > /dev/null; then
            echo "backend=true" >> "$GITHUB_OUTPUT"
          else
            echo "backend=false" >> "$GITHUB_OUTPUT"
          fi
          
          # Check if workflows changed
          if echo "$CHANGED_FILES" | grep -E '^\.github/workflows/' > /dev/null; then
            echo "workflows=true" >> "$GITHUB_OUTPUT"
          else
            echo "workflows=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Calculate change statistics
        id: stats
        run: |
          # Get diff statistics
          STATS=$(git diff --stat "${{ github.event.pull_request.base.sha }}" "${{ github.sha }}")
          LINES_CHANGED=$(echo "$STATS" | tail -1 | grep -o '[0-9]\+ insertion\|[0-9]\+ deletion' | grep -o '[0-9]\+' | awk '{sum += $1} END {print sum+0}')
          echo "lines-changed=$LINES_CHANGED" >> "$GITHUB_OUTPUT"
          echo "Detected $LINES_CHANGED lines changed"

      - name: ğŸ§± Post LEGO Building Plan Comment
        uses: actions/github-script@v8
        with:
          script: |
            const linesChanged = ${{ steps.stats.outputs.lines-changed }};
            const frontendChanged = ${{ steps.changes.outputs.frontend }};
            const backendChanged = ${{ steps.changes.outputs.backend }};
            const workflowsChanged = ${{ steps.changes.outputs.workflows }};
            
            // Determine LEGO building complexity
            let complexity = "";
            let emoji = "";
            if (linesChanged < 50) {
              complexity = "Small LEGO kit";
              emoji = "ğŸ§±";
            } else if (linesChanged < 200) {
              complexity = "Medium LEGO set";
              emoji = "ğŸ¢";
            } else if (linesChanged < 500) {
              complexity = "Large LEGO construction";
              emoji = "ğŸ°";
            } else {
              complexity = "Master Builder project";
              emoji = "ğŸŒŸ";
            }
            
            const changes = [];
            if (frontendChanged) changes.push("Frontend (React/TypeScript)");
            if (backendChanged) changes.push("Backend (FastAPI/Python)");
            if (workflowsChanged) changes.push("GitHub Actions Workflows");
            
            const comment = `## ${emoji} LEGO Quality Gate Analysis
            
            **Building Complexity:** ${complexity} (${linesChanged} lines changed)
            **Components Modified:** ${changes.join(", ") || "Documentation/Config only"}
            
            ### ğŸš€ Quality Checks Starting...
            The automated quality gates are now running to ensure all LEGO pieces fit together perfectly!
            
            - ğŸ” **Linting**: Checking code formatting and style
            - âœ¨ **Quality**: Running comprehensive code analysis
            - ğŸ›¡ï¸ **Security**: Deep vulnerability scanning with Safety Action
            - ğŸ³ **Build Test**: Verifying Docker containers build successfully
            
            *Like any good LEGO instruction manual, we'll verify each step before moving to the next! ğŸ“‹*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # ğŸ” Frontend Linting (parallel)
  lint-frontend:
    name: ğŸ¨ Lint Frontend (ESLint)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.frontend-changed == 'true'
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  # ğŸ Backend Linting (parallel)
  lint-backend:
    name: ğŸ Lint Backend (Pylint + Black)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.backend-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pylint black

      - name: Check Black formatting
        run: |
          cd backend
          black . --check --line-length=88 --exclude=alembic

      - name: Run Pylint
        run: |
          export PYTHONPATH=$PYTHONPATH:./backend
          pylint backend --rcfile=.pylintrc

  # ğŸ”§ GitHub Actions Workflow Linting (parallel)
  lint-workflows:
    name: ğŸ”§ Lint GitHub Actions Workflows (actionlint)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.workflows-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Install actionlint
        run: |
          # Download and install actionlint
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          sudo mv ./actionlint /usr/local/bin/actionlint
          actionlint --version

      - name: Lint GitHub Actions workflows
        run: |
          echo "ğŸ”§ Linting GitHub Actions workflows with actionlint..."
          actionlint -verbose .github/workflows/*
          echo "âœ… All workflows passed linting!"

      - name: Post workflow linting results
        if: failure()
        uses: actions/github-script@v8
        with:
          script: |
            const comment = `## âŒ GitHub Actions Workflow Linting Failed
            
            The GitHub Actions workflows have linting issues that need to be fixed.
            
            **What this means:**
            - Workflow syntax errors or best practice violations detected
            - This could cause CI/CD failures in the future
            - All workflows should pass \`actionlint\` validation
            
            **How to fix:**
            1. Run \`actionlint -verbose .github/workflows/*\` locally
            2. Fix any reported issues (syntax errors, shellcheck warnings, etc.)
            3. Commit and push the fixes
            
            **Why we check this:**
            - Prevents workflow failures that break CI/CD
            - Ensures GitHub Actions follow best practices
            - Catches configuration errors before they impact PRs
            
            ğŸ§± *Like LEGO instructions, our workflows need to be perfectly clear and error-free!*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # âœ¨ Frontend Code Quality (parallel)
  quality-frontend:
    name: âœ¨ Frontend Quality (TypeScript + Prettier)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.frontend-changed == 'true'
    defaults:
      run:
        working-directory: frontend

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Check TypeScript
        run: npm run type-check

      - name: Check Prettier formatting
        run: npm run format:check

      - name: Run tests
        run: npm run test

  # ğŸ Backend Code Quality (parallel)
  quality-backend:
    name: âœ¨ Backend Quality (Testing + Security)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.backend-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r backend/requirements.txt
          pip install pytest pytest-cov safety bandit

      - name: Security check with bandit
        run: |
          cd backend
          bandit -r . -f json -o bandit-report.json -x tests/ || true

      - name: Dependency security check
        run: safety check

      - name: Run tests (if any)
        run: |
          cd backend
          python -m pytest --cov=. --cov-report=xml || echo "No tests found, skipping"

  # ğŸ›¡ï¸ Safety Action Security Check (parallel)
  safety-security-check:
    name: ğŸ›¡ï¸ Deep LEGO Security Scan (Safety Action)
    runs-on: ubuntu-latest
    needs: discover-changes
    if: needs.discover-changes.outputs.backend-changed == 'true'
    
    steps:
      - name: ğŸ“ Get LEGO Security Instructions
        uses: actions/checkout@v5
      
      - name: ğŸ›¡ï¸ Run Safety CLI to check for vulnerabilities
        uses: pyupio/safety-action@v1
        with:
          api-key: ${{ secrets.SAFETY_API_KEY }}
          
      - name: ğŸ¯ Safety scan completed
        run: echo "ğŸ§± Safety Action security scan completed successfully!"


  # ğŸ³ Backend Build Test
  build-test-backend:
    name: ğŸ³ LEGO Backend Assembly Test (Docker Build)
    runs-on: ubuntu-latest
    needs: [discover-changes, lint-frontend, lint-backend, lint-workflows, quality-frontend, quality-backend, safety-security-check]
    if: always() && !contains(needs.*.result, 'failure') && needs.discover-changes.outputs.backend-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build backend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.backend
          push: false
          tags: nextdns-backend:pr-${{ github.event.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ğŸ³ Frontend Build Test
  build-test-frontend:
    name: ğŸ³ LEGO Frontend Assembly Test (Docker Build)
    runs-on: ubuntu-latest
    needs: [discover-changes, lint-frontend, lint-backend, lint-workflows, quality-frontend, quality-backend, safety-security-check]
    if: always() && !contains(needs.*.result, 'failure') && needs.discover-changes.outputs.frontend-changed == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build frontend Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile.frontend
          push: false
          tags: nextdns-frontend:pr-${{ github.event.number }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ğŸ“Š Final Summary
  quality-gate-summary:
    name: ğŸ“Š LEGO Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [discover-changes, lint-frontend, lint-backend, lint-workflows, quality-frontend, quality-backend, safety-security-check, build-test-backend, build-test-frontend]
    if: always()

    steps:
      - name: ğŸ¯ Post Quality Gate Results
        uses: actions/github-script@v8
        with:
          script: |
            const needs = ${{ toJson(needs) }};
            const linesChanged = needs['discover-changes'].outputs['lines-changed'];
            
            // Determine overall status
            let allPassed = true;
            let results = [];
            
            // Check each job result
            Object.entries(needs).forEach(([job, result]) => {
              if (job === 'discover-changes') return;
              
              const jobNames = {
                'lint-frontend': 'ğŸ¨ Frontend Linting',
                'lint-backend': 'ğŸ Backend Linting',
                'lint-workflows': 'ğŸ”§ Workflow Linting',
                'quality-frontend': 'âœ¨ Frontend Quality',
                'quality-backend': 'âœ¨ Backend Quality',
                'safety-security-check': 'ğŸ›¡ï¸ Safety Security Scan',
                'build-test-backend': 'ğŸ³ Backend Docker Build',
                'build-test-frontend': 'ğŸ³ Frontend Docker Build'
              };
              
              if (result.result === 'failure') {
                allPassed = false;
                results.push(`âŒ ${jobNames[job] || job}: Failed`);
              } else if (result.result === 'success') {
                results.push(`âœ… ${jobNames[job] || job}: Passed`);
              } else if (result.result === 'skipped') {
                results.push(`â­ï¸ ${jobNames[job] || job}: Skipped (no changes)`);
              }
            });
            
            const status = allPassed ? "ğŸ‰ **Ready to Build!**" : "ğŸ”§ **Needs Attention**";
            const emoji = allPassed ? "ğŸ—ï¸" : "âš ï¸";
            
            const comment = `## ${emoji} LEGO Quality Gate Results
            
            ${status}
            
            ### ğŸ“‹ Build Plan Results (${linesChanged} lines changed):
            ${results.join('\n')}
            
            ${allPassed ? 
              "### ğŸŠ All Quality Checks Passed!\nYour LEGO pieces fit perfectly together! The PR is ready for review and can be merged to trigger the production build." : 
              "### ğŸ”§ Quality Issues Detected\nSome LEGO pieces need adjustment before they can fit together properly. Please check the failed jobs above and fix the issues."
            }
            
            ---
            *Built with â¤ï¸ using the LEGO methodology - every piece matters!* ğŸ§±`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
# All dependencies successfully consolidated and tested
